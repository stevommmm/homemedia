<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>HomeMedia</title>
	<style type="text/css">
		* {
			box-sizing: border-box;
		}
		body {
			background-color: #242424;
			color: #d3d3d3;
			padding: 0;
			margin: 0;
			font-size: 22px;
			font-family: Verdana, Arial, Helvetica, sans-serif;
		}
		.mediaitem {
			display: block;
			position: relative;
			border-bottom: 1px solid #333;
		}
		.mediaitem > a {
			display: inline-block;
			padding: 0.5rem 1rem;
			color: inherit;
			text-decoration: none;
		}
		.mediaitem > .direct {
			float: right;
		}
		a:visited {
			color: green;
		}
		.content {
			width: 100%;
			position: relative;
			margin: 0 auto;
			font-size: 1rem;
			padding: 2rem;
			display: block;
		}
		input, button {
			display: inline-block;
			padding: 0.6rem 1rem;
			border: 1px solid #000;
			border-radius: 3px;
			background-color: #333;
			color: #efefef;
			line-height: 1.2rem;
			font-size: 1rem;
		}
		button#stop {
			background-color: #633;
		}
		video {
			width: 100%;
			background-color: #000;
			display: none;
			height: auto;
			max-height: 100vh;
			margin: 0 auto;
			resize: both;
		}
	</style>
</head>
<body>
	<!-- poster tag for random image? -->
	<video preload=none controls></video>
	<div class=content>
		<div class=controls>
			<input type=number min=0 id=si placeholder="Subtitle Index">
			<button type=button id=fwd>&gt;&gt;</button>
			<button type=button id=back>&lt;&lt;</button>
			<button type=button id=stop>Stop</button>
		</div>
	</div>
	<script type="text/javascript">
		const content = document.querySelector('.content');
		const v = document.querySelector('video');
		const stopb = document.querySelector('button#stop')
		const fwdb = document.querySelector('button#fwd')
		const backb = document.querySelector('button#back')
		const subindex = document.querySelector('input#si')

		stopb.addEventListener('click', (ev) => {
			v.pause();
			v.currentTime = 0;
			while (v.firstChild) {
				v.removeChild(v.lastChild);
			}
			v.load();
			v.style.display = "none";
			history.pushState({},"", "/");
		});

		fwdb.addEventListener('click', (ev) => {
			v.currentTime += 10;
		});
		backb.addEventListener('click', (ev) => {
			v.currentTime -= 10;
		});

		function videoHandler(e) {
			e.preventDefault();
			history.pushState({},"", e.target);

			let src=document.createElement('source');
			src.src=`${e.target}?si=${subindex.value}`;
			src.type='video/webm';
			src.addEventListener('error', (ev) => { alert("Cant load media, bad subtitles?") });
			v.addEventListener("loadeddata", (ev) => {
				v.play();
			});

			v.pause();
			v.replaceChildren(src);
			v.load();
			v.style.display = "block";
			window.scrollTo(0, 0);
		}

		async function xmlreq(method, url) {
			const x = new DOMParser();
			const e = await fetch(url, {method: method});

			return x.parseFromString(await e.text(), "text/xml");
		}

		window.addEventListener('load', async () => {
			let doc = await xmlreq('PROPFIND', '/');
			for (n of doc.querySelectorAll('response')) {
				let href = n.querySelector('href').textContent;
				let display = n.querySelector('displayname').textContent;
				let ctype = n.querySelector('getcontenttype');

				if (ctype !== null && ctype.textContent.startsWith('video/')) {
					let p = document.createElement('p');
					p.classList.add("mediaitem");

					let inline = document.createElement('a');
					inline.classList.add('inline');
					inline.href = href;
					inline.appendChild(document.createTextNode(display));
					inline.addEventListener('click', videoHandler);
					p.appendChild(inline);

					content.appendChild(p);
				}
			}
		});
	</script>
</body>
</html>
